# xt - Translation Spec Build System

A tspec-based build system for comparing target triples and compile/linker commands across apps.

**Status:** In development on `xt-dev` branch.

## Usage

```bash
cargo xt build ex-x1-xt                     # Build with crate's tspec.toml
cargo xt build ex-x1-xt -t tspec-expr.toml  # Build with experimental spec
cargo xt run ex-x1-xt                       # Build and run
cargo xt test ex-x2-xt                      # Build and test
cargo xt build ex-glibc                     # Works without tspec.toml too
cargo xt test ex-musl                       # Musl target via tspec.toml
```

The `-t` flag is for experimentation - pointing to alternative spec files.
Future: use `save_spec_snapshot` to create `tspec-001-abc123de.toml` variants.

## Design

See [notes/xt-design.md](../notes/xt-design.md) for full design documentation.
See [notes/xt-dev.md](../notes/xt-dev.md) for development notes and the linker flag scoping issue.

Key concepts:
- **App specs** - Apps define build requirements in `apps/<app>/tspec.toml`
- **tspec.toml is optional** - Crates without one get plain `cargo build/test`
- **Generated build.rs** - xt generates temporary build.rs for scoped linker flags

### How Linker Flags Work

xt generates a temporary `build.rs` to apply linker flags with binary-scoped directives:

```rust
// Generated by xt - deleted after build
fn main() {
    println!("cargo:rustc-link-arg-bin=ex-x2-xt=-static");
    println!("cargo:rustc-link-arg-bin=ex-x2-xt=-nostdlib");
    // ...
}
```

This is necessary because RUSTFLAGS affects ALL compilations (including dependency
build scripts), causing crashes with flags like `-nostartfiles`. The generated
build.rs scopes flags to just the binary. See [notes/xt-dev.md](../notes/xt-dev.md)
for the full explanation.

### Spec Saving

Two save formats support different workflows:

- **`save_spec(spec, path)`** - Canonical specs with simple names (`rlibc-x1.toml`)
- **`save_spec_snapshot(spec, name, dir)`** - Iteration snapshots as `{name}-{seq:03}-{hash}.toml`

Snapshots allow quick experimentation with automatic breadcrumbs. Instead of
disciplined git commits to preserve each iteration, snapshots accumulate as
`rlibc-x1-001-abc123de.toml`, `rlibc-x1-002-def456gh.toml`, etc. The sequence
number enables chronological sorting; the hash identifies content.

## Testing

```bash
cargo test -p xt              # run all xt tests
cargo test -p xt -- --nocapture  # see println output
cargo test -p xt spec_default    # run specific test
```

- Unit tests live alongside code in each module using `#[cfg(test)]` blocks
- Integration tests in `tests/` use fixtures from `tests/data/`

## Development Plan

### Completed

1. ~~Create `types.rs` - Spec parameter enums~~ Done
2. ~~Create `tspec.rs` - Loading and resolving specs from TOML~~ Done
3. ~~Implement build command~~ Done
4. ~~Implement run command~~ Done
5. ~~Implement test command~~ Done
6. ~~Generated build.rs for scoped linker flags~~ Done
7. ~~Support target_triple in tspec.toml~~ Done

### Next Steps

1. Support `build_std` in tspec.toml for maximal optimization
2. Spec comparison tooling

### File Structure

```
xt/
  src/
    lib.rs          # Library root, exposes modules
    main.rs         # Entry point, dispatch
    cli.rs          # Clap CLI definitions
    types.rs        # Spec parameter types
    tspec.rs        # Spec loading/saving/hashing
    find_paths.rs   # Workspace/crate/tspec discovery
    build.rs        # Build command + generated build.rs
    run.rs          # Run command implementation
    testing.rs      # Test command implementation
  tests/
    data/           # Test fixtures (TOML specs)
    tspec_test.rs   # Integration tests
```
