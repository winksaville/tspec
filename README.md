# tspec - Translation Spec Build System

A spec-driven build system for Rust that wraps cargo with configurable target triples, compiler flags, and linker options.

**Status:** Active development. Works with both workspaces and single-package projects (POPs).

## Installation

```bash
cargo install --path .
```

Or run directly:
```bash
cargo run -- build
```

## Usage

```bash
tspec build                           # Build current package (or all in workspace)
tspec build -p myapp                  # Build specific package
tspec build -p myapp -t tspec-opt.ts.toml  # Build with alternative spec
tspec build -p myapp -r -s            # Build release, strip symbols
tspec run -p myapp                    # Build and run
tspec test -p myapp                   # Build and test
tspec compare -p myapp -r             # Compare all tspec*.ts.toml by binary size
tspec build -a                        # Build all packages (even from inside a package dir)
```

The `-p` flag specifies a package (defaults to current directory if in a package, otherwise all packages).
Use `-a, --all` to force all-packages mode even when inside a package directory.
The `-t` flag selects a tspec file; if omitted and `tspec.ts.toml` exists, it's used automatically.

## tspec Files

Translation specs are TOML files (conventionally `*.ts.toml`) that configure builds:

```toml
# tspec.ts.toml - Example spec
[cargo]
profile = "release"
target_triple = "x86_64-unknown-linux-musl"

[rustc]
opt_level = "z"
panic = "abort"
lto = true
codegen_units = 1

[linker]
args = ["-static", "-nostartfiles"]
```

### Key Concepts

- **tspec.ts.toml is optional** - Packages without one get plain `cargo build/test`
- **Generated build.rs** - tspec generates temporary build.rs for scoped linker flags
- **Spec comparison** - Compare binary sizes across different specs

### How Linker Flags Work

tspec generates a temporary `build.rs` to apply linker flags with binary-scoped directives:

```rust
// Generated by tspec - deleted after build
fn main() {
    println!("cargo:rustc-link-arg-bin=myapp=-static");
    println!("cargo:rustc-link-arg-bin=myapp=-nostdlib");
}
```

This is necessary because RUSTFLAGS affects ALL compilations (including dependency
build scripts), causing crashes with flags like `-nostartfiles`. The generated
build.rs scopes flags to just the binary.

## tspec Management (ts subcommand)

Manage spec files without manual TOML editing:

```bash
tspec ts list                         # List all tspec files
tspec ts list -p myapp                # List tspec files for a package
tspec ts show -p myapp                # Show tspec contents
tspec ts show -p myapp -t tspec-opt   # Show specific tspec
tspec ts hash -p myapp                # Show content hash
tspec ts new -p myapp                 # Create tspec.ts.toml
tspec ts new experiment -p myapp      # Create experiment.ts.toml
tspec ts new opt2 -p myapp -f tspec-opt  # Copy from existing spec
tspec ts set strip=symbols -p myapp   # Set value, create versioned snapshot
```

Note: Use `ts` as the subcommand (short for "tspec management").

## Testing

```bash
cargo test                    # Run all tests
cargo test -- --nocapture     # See println output
cargo test spec_default       # Run specific test
```

## Project Structure

```
tspec/
  src/
    lib.rs          # Library root, exposes modules
    main.rs         # Entry point, dispatch
    cli.rs          # Clap CLI definitions
    types.rs        # Spec parameter types
    tspec.rs        # Spec loading/saving/hashing
    find_paths.rs   # Project/crate/tspec/binary path discovery
    workspace.rs    # Workspace member discovery
    cargo_build.rs  # Build command + generated build.rs
    run.rs          # Run command implementation
    testing.rs      # Test command implementation
    compare.rs      # Compare command (size comparison)
    all.rs          # Batch operations (build_all, run_all, test_all)
    ts_cmd/         # Tspec management subcommands
    binary.rs       # Binary operations (strip, size)
  tests/
    data/           # Test fixtures (TOML specs)
    tspec_test.rs   # Integration tests
  notes/            # Design docs and todo tracking
```

## Development

See [notes/todo.md](notes/todo.md) for current tasks.

### Verification

```bash
cargo test
cargo clippy --all-targets
cargo fmt --check
```

## Origin

Originally developed as `xt` within the [rlibc-x](https://github.com/user/rlibc-x) project, then extracted to a standalone tool. The git history was preserved using `git subtree split`.

## License

Licensed under either of

- Apache License, Version 2.0 ([LICENSE-APACHE](LICENSE-APACHE) or http://apache.org/licenses/LICENSE-2.0)
- MIT license ([LICENSE-MIT](LICENSE-MIT) or http://opensource.org/licenses/MIT)

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall
be dual licensed as above, without any additional terms or conditions.
