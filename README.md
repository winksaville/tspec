# xt - Translation Spec Build System

A tspec-based build system for comparing target triples and compile/linker commands across apps.

See [Claude Code Sessions](../README.md#claude-code-sessions) for how `.claude/` session files are managed in this repo.

**Status:** Active - primary build system (replaced xtask).

## Usage

```bash
cargo xt build -p ex-x1                     # Build with package's tspec.ts.toml
cargo xt build -p ex-x1 -t tspec-expr.toml  # Build with alternative spec
cargo xt build -p ex-x2 -t tspec-opt.toml -r -s  # Build optimized, strip
cargo xt run -p ex-x1                       # Build and run
cargo xt test -p ex-x2                      # Build and test
cargo xt build -p ex-glibc                  # Works without tspec.ts.toml too
cargo xt compare -p ex-x2 -r                # Compare all tspec*.ts.toml
cargo xt compare -p ex-x2 -t "*.ts.toml" -r # Compare with glob pattern
cargo xt build                              # Build all packages (from workspace root)
cargo xt build -a                           # Build all packages (even from inside a package dir)
```

The `-p` flag specifies a package (defaults to current directory if in a package, otherwise all packages).
Use `-a, --all` to force all-packages mode even when inside a package directory.
The `-t` flag is optional - use it to try alternative spec files without modifying `tspec.toml`.

## Design

See [notes/xt-design.md](../notes/xt-design.md) for full design documentation.
See [notes/xt-dev.md](../notes/xt-dev.md) for development notes and the linker flag scoping issue.

Key concepts:
- **App specs** - Apps define build requirements in `apps/<app>/tspec.ts.toml`
- **tspec.ts.toml is optional** - Crates without one get plain `cargo build/test`
- **Generated build.rs** - xt generates temporary build.rs for scoped linker flags

### How Linker Flags Work

xt generates a temporary `build.rs` to apply linker flags with binary-scoped directives:

```rust
// Generated by xt - deleted after build
fn main() {
    println!("cargo:rustc-link-arg-bin=ex-x2-xt=-static");
    println!("cargo:rustc-link-arg-bin=ex-x2-xt=-nostdlib");
    // ...
}
```

This is necessary because RUSTFLAGS affects ALL compilations (including dependency
build scripts), causing crashes with flags like `-nostartfiles`. The generated
build.rs scopes flags to just the binary. See [notes/xt-dev.md](../notes/xt-dev.md)
for the full explanation.

### Spec Saving

Two save formats support different workflows:

- **`save_spec(spec, path)`** - Canonical specs with simple names (`rlibc-x1.toml`)
- **`save_spec_snapshot(spec, name, dir)`** - Iteration snapshots as `{name}-{seq:03}-{hash}.toml`

Snapshots allow quick experimentation with automatic breadcrumbs. Instead of
disciplined git commits to preserve each iteration, snapshots accumulate as
`rlibc-x1-001-abc123de.toml`, `rlibc-x1-002-def456gh.toml`, etc. The sequence
number enables chronological sorting; the hash identifies content.

## Testing

```bash
cargo test -p xt              # run all xt tests
cargo test -p xt -- --nocapture  # see println output
cargo test -p xt spec_default    # run specific test
```

- Unit tests live alongside code in each module using `#[cfg(test)]` blocks
- Integration tests in `tests/` use fixtures from `tests/data/`

## Development Plan

### Completed

1. ~~Create `types.rs` - Spec parameter enums~~ Done
2. ~~Create `tspec.rs` - Loading and resolving specs from TOML~~ Done
3. ~~Implement build command~~ Done
4. ~~Implement run command~~ Done
5. ~~Implement test command~~ Done
6. ~~Generated build.rs for scoped linker flags~~ Done
7. ~~Support target_triple in tspec.toml~~ Done
8. ~~Support `build_std` for nightly optimized builds~~ Done
9. ~~Support `version_script` for symbol visibility~~ Done
10. ~~Support `panic = "immediate-abort"` (nightly)~~ Done
11. ~~Strip flag (`-s`) for build and run commands~~ Done
12. ~~Compare command for spec comparison~~ Done
13. ~~Path resolution for crates and tspec files~~ Done

### Phase 1: Spec Comparison (feature parity with xtask) - Done

Compare specs to see size differences:

```bash
cargo xt compare -p ex-x2 -r                # All tspec*.ts.toml in package dir
cargo xt compare -p ex-x2 -t "*.ts.toml" -r # Explicit glob pattern
cargo xt compare -p ex-x2 -t a.toml -t b.toml -r  # Explicit file list
```

Output shows specs sorted by size (smallest first) with percent change from largest.

### Phase 2: Merge to Main - Done

1. ~~Create `xtask` branch from current main (preservation)~~
2. ~~Merge `xt-dev` to main~~
3. ~~Remove xtask crate~~
4. ~~Update CLAUDE.md with new commands~~

### Phase 3: Interactive tspec Management

Enable fast iteration without manual TOML editing:

```bash
cargo xt ts list                             # List all tspec files in workspace
cargo xt ts list -p ex-x2                    # List tspec files for a package
cargo xt ts show -p ex-x2                    # Show all tspec contents for package
cargo xt ts show -p ex-x2 -t tspec-opt       # Show specific tspec
cargo xt ts hash -p ex-x2                    # Show content hash
cargo xt ts new -p ex-x2                     # Create tspec.ts.toml
cargo xt ts new experiment -p ex-x2          # Create experiment.ts.toml
cargo xt ts new ts-opt2 -p ex-x2 -f tspec-opt  # Copy from existing spec
cargo xt ts set strip=symbols -p ex-x2       # Set value, create versioned file
cargo xt ts set rustc.lto=true -p ex-x2 -t opt  # Set value in specific tspec
cargo xt ts add linker.args="-static" -p myapp  # (TODO)
cargo xt ts remove rustc.panic -p myapp      # (TODO)
```

Note: `tspec` and `ts` are aliases for the same subcommand.

See [notes/interactive-tspec.md](../notes/interactive-tspec.md) for design details.

### File Structure

```
xt/
  src/
    lib.rs          # Library root, exposes modules
    main.rs         # Entry point, dispatch
    cli.rs          # Clap CLI definitions
    types.rs        # Spec parameter types
    tspec.rs        # Spec loading/saving/hashing
    find_paths.rs   # Workspace/crate/tspec/binary path discovery
    workspace.rs    # Workspace member discovery
    cargo_build.rs  # Build command + generated build.rs
    run.rs          # Run command implementation
    testing.rs      # Test command implementation
    compare.rs      # Compare command (size comparison)
    all.rs          # Batch operations (build_all, run_all, test_all)
    ts_cmd/         # Tspec subcommands
      mod.rs        # Module exports
      list.rs       # ts list command
      show.rs       # ts show command
      hash.rs       # ts hash command
      new.rs        # ts new command
      set.rs        # ts set command (creates versioned file)
    binary.rs       # Binary operations (strip, size)
    print_hline.rs  # Horizontal line macro for output formatting
    print_header.rs # Header macro (uses print_hline!)
  tests/
    data/           # Test fixtures (TOML specs)
    tspec_test.rs   # Integration tests
```

## Workflow

### Progress Tracking

See [notes/todo.md](../notes/todo.md) for current Done/Todo status.

Discussion and design rationale lives in `notes/chores-<date>.md` files. The todo file references these but doesn't duplicate content.

### Completing Changes

When finishing a set of changes:

1. Update relevant design log with new dated section
2. Update `notes/todo.md` - move items from Todo to Done
3. Run verification loop:
   ```bash
   cargo xt test -p xt && cargo xt test
   cargo clippy --workspace --all-targets
   cargo fmt --check
   ```
4. Commit with conventional commit message

### Claude Code & Git

The `.claude/` directory contains session state that updates during conversations.

**After Claude commits code:**
1. Claude says "Committed abc123." then "Remember to commit .claude/ session files."
2. User should commit `.claude/` files separately (or amend)
3. On next prompt, if `.claude/` wasn't committed, Claude asks: "Did you forget to commit .claude sessions?"

**Why separate commits:** The `.claude/` files update continuously during conversation, so they're always dirty mid-session. Committing them separately keeps code commits clean.

**Before merging:**
- **Always exit Claude first** - merging while Claude runs risks conflicts in `.claude/`
- Exit ensures session state is consistent with the code being merged
