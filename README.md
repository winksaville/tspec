# tspec - Translation Spec Build System

A spec-driven build system for Rust that wraps cargo with configurable target triples, compiler flags, and linker options. Each tspec applies to a Cargo **package** â€” the unit with a `Cargo.toml`. If different crates need different compilation settings, they should be in separate packages.

**Status:** Active development. Works with both workspaces and single-package projects (POPs).

## Installation

```bash
cargo install --path .
```

Or run directly:
```bash
cargo run -- build
```

## Usage

```bash
tspec build                                # Build current package (or all in workspace) with tspec.ts.toml if present
tspec build -p myapp                       # Build specific package with tspec.ts.toml if present
tspec build -p myapp -t tspec-opt          # Build with alternative spec tspec-opt.ts.toml
tspec build -p myapp -t tspec-opt.ts.toml  # Build with alternative spec tspec-opt.ts.toml
tspec build -p myapp -r -s                 # Build release, strip symbol with tspec.ts.toml if present
tspec run -p myapp                         # Build and run with tspec.ts.toml if present
tspec test -p myapp                        # Build and test with tspec.ts.toml if present
tspec build -w                             # Build all packages (even from inside a package dir)
tspec compare -p myapp -r                  # Compare all tspec*.ts.toml by binary size
```

The `-p` flag specifies a package (defaults to current directory if in a package, otherwise all packages).
Use `-w, --workspace` to force all-packages mode even when inside a package directory.
The `-t` flag selects a tspec file; if omitted and `tspec.ts.toml` exists, it's used automatically.

## tspec Files

Translation specs are TOML files (conventionally `*.ts.toml`) that configure builds:

```toml
# tspec.ts.toml - all supported fields shown

# Top-level high-level options (expand to lower-level cargo/rustc flags)
panic = "abort"                            # "unwind" (default), "abort", "immediate-abort" (nightly)
strip = "symbols"                          # "none" (default), "debuginfo", "symbols"

[cargo]
profile = "release"                        # "debug" (default), "release"
target_triple = "x86_64-unknown-linux-musl"
target_json = "path/to/custom-target.json" # custom target spec (mutually exclusive with target_triple)
unstable = ["panic-immediate-abort"]       # -Z flags (nightly only)
target_dir = "<name>"                      # per-spec target dir; supports <name> and <hash> placeholders

[rustc]
opt_level = "z"                            # "0", "1", "2", "3", "s", "z"
panic = "abort"                            # "abort", "unwind", "immediate-abort" (prefer top-level panic)
lto = true
codegen_units = 1
build_std = ["core", "alloc"]              # crates to rebuild with -Z build-std (nightly)
flags = ["-C", "relocation-model=static"]  # raw rustc flags passed through

[linker]
args = ["-static", "-nostartfiles"]

[linker.version_script]                    # symbol visibility control (enables --gc-sections)
global = ["_start"]                        # symbols to keep
local = "*"                                # default: "*" (hide everything else)
```

The top-level `panic` sets both cargo `-Z` and rustc `-C` flags automatically. If both
top-level `panic` and `rustc.panic` are set, both are applied (prefer one or the other).

### Key Concepts

- **One tspec per package** - A tspec applies to all crates (targets) within a Cargo package. For per-crate control, use separate packages in a workspace.
- **tspec.ts.toml is optional** - Packages without one get plain `cargo build/test`
- **Generated build.rs** - tspec generates temporary build.rs for scoped linker flags
- **Spec comparison** - Compare binary sizes across different specs

### How Linker Flags Work

tspec generates a temporary `build.rs` to apply linker flags with binary-scoped directives:

```rust
// Generated by tspec - deleted after build
fn main() {
    println!("cargo:rustc-link-arg-bin=myapp=-static");
    println!("cargo:rustc-link-arg-bin=myapp=-nostdlib");
}
```

This is necessary because RUSTFLAGS affects ALL compilations (including dependency
build scripts), causing crashes with flags like `-nostartfiles`. The generated
build.rs scopes flags to just the binary.

## tspec Management (ts subcommand)

Manage spec files without manual TOML editing:

```bash
tspec ts list                            # List all tspec files
tspec ts list -p myapp                   # List all tspec files for a package
tspec ts show -p myapp                   # Show all tspec contents, i.e. *.ts.toml
tspec ts show -p myapp -t tspec-opt      # Show specific tspec-opt.ts.toml
tspec ts hash -p myapp                   # Show content hash of tspec.ts.toml
tspec ts hash -p myapp -t tspec-opt      # Show content hash of tspec-opt.ts.toml
tspec ts new -p myapp                    # Create tspec.ts.toml
tspec ts new experiment -p myapp         # Create experiment.ts.toml
tspec ts new opt2 -p myapp -f tspec-opt  # Copy from existing spec creating opt2.ts.toml
tspec ts set strip=symbols -p myapp      # Set value in tspec.ts.toml
tspec ts backup -p myapp                 # Create versioned backup (name-NNN-hash.ts.toml)
tspec ts backup -p myapp -t tspec-opt    # Backup myapp/tspec-opt.ts.toml to myapp/tspec-opt-<next-seqnum>-<hash>.ts.toml
tspec ts restore -t t1-001-abcd1234      # Restore t1.ts.toml from backup t1-001-abcd1234.ts.toml
```

Backups are valid spec files and can be used directly with `-t`.

Note: Use `ts` as the subcommand (short for "tspec management").

## Testing

```bash
cargo test                    # Run all tests
cargo test -- --nocapture     # See println output
cargo test spec_default       # Run specific test
```

## Project Structure

```
tspec/
  src/
    lib.rs          # Library root, exposes modules
    main.rs         # Entry point, dispatch
    cli.rs          # Clap CLI definitions
    types.rs        # Spec parameter types
    tspec.rs        # Spec loading/saving/hashing
    find_paths.rs   # Project/package/tspec/binary path discovery
    workspace.rs    # Workspace package discovery
    cargo_build.rs  # Build command + generated build.rs
    run.rs          # Run command implementation
    testing.rs      # Test command implementation
    compare.rs      # Compare command (size comparison)
    all.rs          # Batch operations (build_all, run_all, test_all)
    ts_cmd/         # Tspec management subcommands
    binary.rs       # Binary operations (strip, size)
  tests/
    data/           # Test fixtures (TOML specs)
    tspec_test.rs   # Integration tests
  notes/            # Design docs and todo tracking
```

## Development

See [notes/todo.md](notes/todo.md) for current tasks.

### Verification

```bash
cargo test
cargo clippy --all-targets
cargo fmt --check
```

## Origin

Originally developed as `xt` within the [rlibc-x](https://github.com/user/rlibc-x) project, then extracted to a standalone tool. The git history was preserved using `git subtree split`.

## License

Licensed under either of

- Apache License, Version 2.0 ([LICENSE-APACHE](LICENSE-APACHE) or http://apache.org/licenses/LICENSE-2.0)
- MIT license ([LICENSE-MIT](LICENSE-MIT) or http://opensource.org/licenses/MIT)

### Contribution

Unless you explicitly state otherwise, any contribution intentionally submitted
for inclusion in the work by you, as defined in the Apache-2.0 license, shall
be dual licensed as above, without any additional terms or conditions.
