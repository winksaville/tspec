# Chores-4

## 20260211 - Fix compare: optional `-p` and glob `-t` handling

### Context

The `compare` command has two issues:

1. **`-p` is required but should be optional.** Build, Run, and Test all default to the current directory package when `-p` is omitted. Compare requires it, which is inconsistent and unnecessary for POPs.

2. **`-t` with shell-expanded globs fails.** The `-t` flag uses clap's `Append` action, which captures only one value per `-t` flag. When the shell expands an unquoted glob like `tspec compare -t *.ts.toml` into `tspec compare -t file1.ts.toml file2.ts.toml`, clap rejects the second file as an unexpected argument.

### Plan

**Step 1: `src/cmd/compare.rs` — Make `-p` optional, fix `-t`**

- Change `package: String` to `Option<String>` with `current_package_name()` fallback
- Change `-t` from `action = Append` to `num_args = 1..` so shell-expanded globs work
- Use `resolve_package_dir()` + `get_package_name()` in `execute()`

**Step 2: Add tests**

- CLI parse tests for `CompareCmd`: optional `-p`, `-t` with multiple values, no `-t` defaults
- `find_tspecs` test for multi-dot filenames (`tspec.musl.ts.toml` matching `tspec*.ts.toml`)

### Result

Done. `-p` is now optional (defaults to cwd package), `-t` accepts shell-expanded globs via `num_args = 1..`. Removed broken spec files (dyn-opt, static-opt). 8 new tests added.

### References

- todo.md items: "-p shouldn't be needed for `ts compare` if in a POP" and "for build, run ... a -t should support glob like in compare"

## 20260212 - Always include cargo --release baseline in compare

### Context

`tspec compare` only compares builds using tspec files. If no tspec files exist, it errors out. We want a plain `cargo build --release` result always included as a baseline reference point — even with zero tspec files.

### Problems

- `build_package(pkg_name, None, release)` auto-discovers default `tspec.ts.toml` if it exists — no way to force a plain build
- `find_tspecs()` errors when no tspec files match — compare can't run without specs
- `compare_specs()` only iterates spec paths, no baseline concept

### Plan

1. Add `build_package_plain()` in `cargo_build.rs` — always does plain cargo build, skips spec lookup
2. Add `build_baseline()` helper in `compare.rs`, modify `compare_specs()` to build cargo --release first
3. Allow empty tspec list in `cmd/compare.rs` — default pattern returns empty vec instead of erroring

### Result

Done. `compare` now always builds a `cargo --release` baseline first, then any tspec builds. Three changes:
- `build_package_plain()` in `cargo_build.rs` — plain cargo build that skips tspec lookup
- `build_baseline()` + modified `compare_specs()` in `compare.rs` — baseline always first in results
- `cmd/compare.rs` — default tspec pattern gracefully returns empty vec (explicit `-t` still errors if no match)

## 20260212 - Detect and remove stale tspec-generated build.rs

### Problem

When a spec with `linker.args` (e.g., musl with `-static -nostdlib`) is built, tspec generates a temporary `build.rs` with `cargo:rustc-link-arg-bin=` directives. If the build is interrupted (Ctrl+C), this `build.rs` is left behind. All subsequent builds — including plain `cargo build --release` — silently pick it up, applying the linker args to every build. With `-static -nostdlib` on glibc, this produces a tiny binary that segfaults immediately (missing C runtime startup code).

### Fix

- Added `is_tspec_generated_build_rs()` — detects tspec-generated files by marker comment (`// Generated by tspec`) or by content (file only contains `cargo:rustc-link-arg-bin=` println lines)
- Added `remove_stale_tspec_build_rs()` — removes stale files before building
- Called from both `build_package()` and `plain_cargo_build_release()`
- Warning printed after build completes (so it's visible after cargo output scrolls by)
- 8 new tests for detection and removal logic
- Added todo item for the larger design question: what to do when a package has a real `build.rs` and the spec has `linker.args`

## 20260212 - Design: tspec-build library for linker.args

### Problem

When a package has its own `build.rs` and a spec has `linker.args`, tspec silently drops the linker args (no warning, no error). The current approach of generating a temporary `build.rs` is fundamentally incompatible with user-owned build scripts.

### Options considered

1. **Error out** — refuse to build, safest but unhelpful
2. **Warn and skip** — build without linker.args, visible but still broken
3. **Merge into existing build.rs** — fragile, modifies user code
4. **Move to RUSTFLAGS** (`-C link-arg=`) — affects all crates including host/proc-macros
5. **Temporarily rename user's build.rs** — interrupt-vulnerable, loses user functionality during build
6. **`tspec-build` library crate** — user calls `tspec_build::emit_linker_flags()` from their build.rs

### Proposed: option 6 — `tspec-build` crate

A small library crate that reads linker.args from the spec and emits `cargo:rustc-link-arg-bin=` directives. User adds it to `[build-dependencies]` and calls it from their build.rs:

```rust
fn main() {
    // user's existing logic
    tspec_build::emit_linker_flags();
}
```

**Benefits:** no file conflicts, interrupt-safe, explicit opt-in, composable with any build.rs logic.

**Open questions:**
- How does the library find the right spec file at build time?
- Should tspec set an env var (e.g., `TSPEC_FILE`) before invoking cargo?
- For packages without build.rs, keep auto-generating or always require the library?

### Decision

Option 6 with a thin implementation:
- `tspec-build` is a standalone crate (no dependency on tspec)
- Only depends on `toml` and `serde` to read the spec file
- Reads `TSPEC_SPEC_FILE` env var (set by tspec before invoking cargo)
- Extracts `linker.args` from the spec
- Emits `cargo:rustc-link-arg-bin=` for each arg using `CARGO_PKG_NAME`
- tspec sets the env var in `apply_spec_to_command()`

### Plan

1. Create `tspec-build/` crate with minimal dependencies
2. Have tspec set `TSPEC_SPEC_FILE` env var when building with a spec
3. Test independently first, then integrate as tspec's own build.rs later

### Status

Implementation in progress

## 20260214 - Add compare --workspace for all-packages mode

### Context

`tspec compare` requires a specific package and errors at workspace root. Build and test
already support `-w`/`--workspace` for all-packages mode. Add the same pattern to compare.

### Plan

1. Add `-w`/`--workspace` and `--fail-fast` flags to CompareCmd
2. Add `compare_all()` and `print_compare_summary()` to `all.rs`
3. Disallow `-t` in all-packages mode (each package uses its own tspecs)
